{% extends 'ligas/base_admin.html' %}
{% block title %}Fixture: {{ torneo.nombre }}{% endblock %}
{% block header %}Fixture de {{ torneo.nombre }}{% endblock %}
{% block breadcrumbs %}<a href="/">Inicio</a> / Administración / <a href="{% url 'ligas:torneo_list' %}">Torneos</a> / Fixture{% endblock %}
{% block actions %}
  <a class="btn" href="{% url 'ligas:torneo_list' %}">Volver</a>
  {% if can_generate and not fixture_exists and club_count >= 2 %}
    <form method="post" style="display:inline-block; margin-left:8px;">
      {% csrf_token %}
      <button type="submit" class="btn primary">Crear fixture</button>
    </form>
  {% endif %}
{% endblock %}
{% block content %}
  <div class="muted">Liga: {{ torneo.liga }}</div>

  {% if fixture_table_missing %}
    <p style="color:#b91c1c; margin-top:12px;">No se detectó la tabla de partidos de fixture. Ejecutá las migraciones pendientes (<code>python manage.py migrate</code>).</p>
  {% endif %}

  {% if club_count < 2 %}
    <p class="muted">Se necesitan al menos dos clubes para generar el fixture.</p>
  {% endif %}

  {% if fixture_exists %}
    <div class="muted" style="margin:16px 0;">
      Cantidad de fechas por ronda: {{ fecha_count }}{% if has_bye %} (con un club libre por fecha){% endif %}.
    </div>
    {% for ronda in fixture_rounds_data %}
      <div style="margin-top:24px;">
        <h3 style="margin-bottom:12px;">{{ ronda.label }}</h3>
        {% if ronda.fechas %}
          <table>
            <thead>
              <tr>
                <th>Local</th>
                <th>Visitante</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for fecha in ronda.fechas %}
                {% for item in fecha.partidos %}
                  <tr>
                    <td>{{ item.partido.club_local.nombre }}</td>
                    <td>{{ item.partido.club_visitante.nombre }}</td>
                    <td>{{ fecha.numero }}</td>
                    <td class="estado estado-{{ item.estado }}">{{ item.estado }}</td>
                    <td>
                      {% if can_manage_resultados %}
                        <a class="btn"
                           href="{% url 'ligas:partido_fixture_resultados' torneo.pk item.partido.pk %}">
                          {% if item.tiene_resultados %}Editar resultados{% else %}Cargar resultados{% endif %}
                        </a>
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if fecha.libre %}
                  <tr class="muted">
                    <td>{{ fecha.libre.nombre }}</td>
                    <td>Libre</td>
                    <td>{{ fecha.numero }}</td>
                    <td class="estado estado-pendiente">pendiente</td>
                    <td>—</td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No hay cruces registrados para esta ronda.</p>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <h2 style="margin-top:24px;">Fixture pendiente</h2>
    {% if club_count >= 2 %}
      <p>El fixture tendrá {{ fecha_count }} fecha{% if fecha_count != 1 %}s{% endif %} por ronda{% if has_bye %}, con un club libre por fecha{% endif %}. Usá el botón "Crear fixture" para generarlo automáticamente.</p>
    {% endif %}
    {% if not can_generate %}
      <p class="muted">No tenés permisos para generar el fixture.</p>
    {% endif %}
  {% endif %}
{% endblock %}
